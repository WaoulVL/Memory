<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend demo</title>

    <style>
        body {font-family: Arial, Helvetica, sans-serif;}
        form {border: 3px solid #f1f1f1; text-align:center;}
        h2 { text-align:center; }

        input[type=text], input[type=password] { width: 100%; padding: 12px 20px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #04AA6D; color: white; padding: 14px 20px; margin: 8px 0; border: none; cursor: pointer; width: 70%; }
        button:hover { opacity: 0.8; }
        .container { padding: 16px; }
        #result { font-size:2rem; text-align:center; }
    </style>
</head>
<body>

    <h2>Frontend demo ðŸ‘‹</h2>

    <p>Start in deze directory een nieuwe host binnen hetzelfde domein als waarop je de backend hebt draaien, maar op een andere poort (bijvoorbeeld <tt>php -S localhost:8080</tt>. Als je de frontend op een ander domein draait, of gewoon als bestand op je file-system opent, krijg je <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors">CORS-errors</a>.</p>

    <p>Deze pagina checkt de verbinding met de backend. Als je hieronder de datum van vandaag te zien krijgt, is de verbinding ok. Er wordt namelijk een call gedaan naar <tt>localhost:8000/frontend</tt>, die de datum van vandaag als json teruggeeft.</p>

    <p>Je kunt hetzelfde ook bereiken door op de knop hieronder te klikken. Check eventueel de console als je denkt dat er dingen niet goed gaan.</p>
        
    <form>
        <button id="btn" value="">Check de connectie</button>
        <button id="register_test" value="">Doe een register test</button>
        <button id="login_test" value="">Doe een login test, krijg token</button>
        <button id="id_test" value="">Krijg id uit opgeslagen JWT</button>
        <button id="data_test" value="">Krijg data uit API met verkregen JWT</button>
    </form>

    <p id="result"></p>
    
</body>

<script>

    const check = () => {
        event.preventDefault()
        fetch('http://localhost:8000/frontend')
        .then( resp => resp.json() )
        .then( json => {
            console.log(json)
            let datum = new Date(json['date']).toLocaleDateString('NL-nl', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'} )
            document.getElementById('result').innerHTML = json['message']
            document.getElementById('result').innerHTML += `<br/>De huidige datum is ${datum}`
        })
    }

    const login_test = () => {
        event.preventDefault()
        fetch('http://localhost:8000/api/login_check', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({
            username: 'Karel',
            password: 'karel'
            })
        })
        .then(response => {
            if (response.status === 200) {
                console.log('Inloggen gelukt')
                return response.json()
            } else {
                console.log('Inloggen niet gelukt')
            }
        })
        .then(data => {
            if (data.token) {
                console.log("Token: " + data.token)
                localStorage.setItem('jwtToken', data.token)
            } else {
                console.log('JWT token niet gevonden')
            }
        })
    }

    const register_test = () => {
        event.preventDefault()
        fetch('http://localhost:8000/register', {
        method: 'POST',
        body: JSON.stringify({
            username: 'Karel',
            email: 'karel@karel',
            password: 'karel'
        }),
        headers: {
            'Content-Type': 'application/json'
        }
        })
        .then(response => {
            if (response.status === 201) {
                console.log('Registreren gelukt')
                document.getElementById('result').innerHTML = 'Registreren gelukt'
            } else {
                console.log('Registreren niet gelukt')
                document.getElementById('result').innerHTML = 'Registreren niet gelukt'
            }
        })
    }

    const createAPIHeaders = () => {
        const headers = {
            'Content-Type': 'application/json'
        }
        jwtToken = localStorage.getItem("jwtToken")
        if (jwtToken) {
            headers['Authorization'] = `Bearer ${jwtToken}`
        }
        return headers
    }

    const printPlayerData = (playerID) => {
        const url = `http://localhost:8000/api/player/${playerID}`

        fetch(url, {
            method: 'GET',
            headers: createAPIHeaders()
        })
        .then(response => {
            if (response.ok) {
                return response.json()
            }
        })
        .then(data => {
            console.log("Gevonden player data: ")
            console.log(data)
        })
    }

    function getPlayerIdFromJWT(jwtToken) {
        const tokenParts = jwtToken.split('.')

        const encodedPayload = tokenParts[1]
        const decodedPayload = atob(encodedPayload)
        const payload = JSON.parse(decodedPayload)

        return payload.sub
    }

    const player_id_test = () => {
        event.preventDefault()
        const id = getPlayerIdFromJWT(localStorage.getItem("jwtToken"))
        console.log("Gevonden player id: " + id)
        return id
    }

    const data_test = () => {
        event.preventDefault()
        const id = getPlayerIdFromJWT(localStorage.getItem("jwtToken"))
        printPlayerData(id)
    }

    document.getElementById('btn').addEventListener('click', c => check() )
    document.getElementById('login_test').addEventListener('click', c => login_test())
    document.getElementById('register_test').addEventListener('click', c => register_test())
    document.getElementById('id_test').addEventListener('click', c => player_id_test())
    document.getElementById('data_test').addEventListener('click', c => data_test())
</script>
</html>
